let currentPlayer="X",board=[["","",""],["","",""],["","",""]],cursorX=0,cursorY=0,gameOver=!1,inMenu=!0,menuOptions=["2 PLAYER","VS CPU"],menuSelection=0,vsCPU=!1;const screenWidth=bC.getWidth(),screenHeight=bC.getHeight(),spacing=10,cellWidth=50,cellHeight=50,boardWidth=3*cellWidth+2*spacing,boardHeight=3*cellHeight+2*spacing,offsetX=(screenWidth-boardWidth)/2+10,offsetY=(screenHeight-boardHeight)/2-16;function drawBoard(){bC.clear(),bC.setFont("6x8",2.5),bC.setColor(10);for(let r=1;r<3;r++){var e=offsetX+r*(cellWidth+spacing)-spacing/2,o=offsetY+r*(cellHeight+spacing)-spacing/2;for(let r=-Math.floor(1.5);r<=Math.floor(1.5);r++)bC.drawLine(e+r,offsetY,e+r,offsetY+boardHeight);for(let r=-Math.floor(1.5);r<=Math.floor(1.5);r++)bC.drawLine(offsetX,o+r,offsetX+boardWidth,o+r)}for(let e=0;e<3;e++)for(let r=0;r<3;r++){var n=board[e][r]||" ",t=offsetX+r*(cellWidth+spacing)+cellWidth/2-8,a=offsetY+e*(cellHeight+spacing)+cellHeight/2-8;bC.drawString(n,t,a)}var r=offsetX+cursorX*(cellWidth+spacing)-2,i=offsetY+cursorY*(cellHeight+spacing)-2,c=r+cellWidth+4,s=i+cellHeight+4;bC.drawRect(r,i,c,s),gameOver||(r=`Player ${currentPlayer}'s turn.`,i=screenHeight-16,bC.drawString(r,(screenWidth-bC.stringWidth(r))/2,i)),bC.flip()}function checkWin(){var r,e;for(r of[board[0],board[1],board[2],[board[0][0],board[1][0],board[2][0]],[board[0][1],board[1][1],board[2][1]],[board[0][2],board[1][2],board[2][2]],[board[0][0],board[1][1],board[2][2]],[board[0][2],board[1][1],board[2][0]]]){if(r.every(r=>"X"===r))return"X";if(r.every(r=>"O"===r))return"O"}for(e of board)if(e.includes(""))return null;return"Draw"}function checkWinner(r){var e,o;for(e of[r[0],r[1],r[2],[r[0][0],r[1][0],r[2][0]],[r[0][1],r[1][1],r[2][1]],[r[0][2],r[1][2],r[2][2]],[r[0][0],r[1][1],r[2][2]],[r[0][2],r[1][1],r[2][0]]]){if(e.every(r=>"X"===r))return"X";if(e.every(r=>"O"===r))return"O"}for(o of r)if(o.includes(""))return null;return"Draw"}function checkWin(){var r,e;for(r of[board[0],board[1],board[2],[board[0][0],board[1][0],board[2][0]],[board[0][1],board[1][1],board[2][1]],[board[0][2],board[1][2],board[2][2]],[board[0][0],board[1][1],board[2][2]],[board[0][2],board[1][1],board[2][0]]]){if(r.every(r=>"X"===r))return"X";if(r.every(r=>"O"===r))return"O"}for(e of board)if(e.includes(""))return null;return"Draw"}function minimax(o,n,t){var a,r=checkWinner(o);if(null!==r)return"O"===r?10-n:"X"===r?n-10:0;if(2<=n)return 0;let i=t?-1/0:1/0;for(let e=0;e<3;e++)for(let r=0;r<3;r++)""===o[e][r]&&(o[e][r]=t?"O":"X",a=minimax(o,n+1,!t),o[e][r]="",i=t?Math.max(a,i):Math.min(a,i));return i}function getBestMove(){let r=-1/0,e=null;var o,n=[];for(let e=0;e<3;e++)for(let r=0;r<3;r++)""===board[e][r]&&n.push({x:r,y:e});if(0===n.length)return null;for(o of n){board[o.y][o.x]="O";var t=minimax(board,0,!1);board[o.y][o.x]="",t>r&&(r=t,e=o)}return e}function showGameOverMessage(r){r="Draw"===r?"It's a draw!":`Player ${r} wins!`;bC.clear(),bC.setFont("6x8",2.5),bC.setColor(10),bC.drawString(r,(screenWidth-bC.stringWidth(r))/2,screenHeight/2),bC.flip(),setTimeout(()=>{showMainMenu()},2e3)}function placeMark(){var r;gameOver||""!==board[cursorY][cursorX]||(board[cursorY][cursorX]=currentPlayer,drawBoard(),(r=checkWin())?(gameOver=!0,showGameOverMessage(r)):(currentPlayer="X"===currentPlayer?"O":"X",!gameOver&&vsCPU&&"O"===currentPlayer&&cpuMove()))}function cpuMove(){if(!gameOver&&vsCPU){let e;(e=""===board[1][1]?{x:1,y:1}:getBestMove())&&setTimeout(()=>{board[e.y][e.x]="O",drawBoard();var r=checkWin();r?(gameOver=!0,showGameOverMessage(r)):(currentPlayer="X",drawBoard())},30)}}function resetGame(){currentPlayer="X",board=[["","",""],["","",""],["","",""]],cursorX=0,cursorY=0,gameOver=!1,bindGameControls(),drawBoard()}function bindGameControls(){Pip.removeAllListeners("knob1"),Pip.on("knob1",r=>{(0===r?placeMark:(cursorY=0<r?(cursorY+2)%3:(cursorY+1)%3,drawBoard))()}),Pip.removeAllListeners("knob2"),Pip.on("knob2",r=>{cursorX=0<r?(cursorX+1)%3:(cursorX+2)%3,drawBoard()}),Pip.removeAllListeners("torch"),Pip.on("torch",exitGame)}function exitGame(){gameOver=!0,inMenu=!0,Pip.removeAllListeners(),showMainMenu()}function showMainMenu(){function e(){bC.clear(),bC.setFont("6x8",2.5),bC.setColor(10);var r="PIP-TAC-TOE";bC.drawString(r,(screenWidth-bC.stringWidth(r))/2,20);for(let r=0;r<menuOptions.length;r++){var e=60+30*r,o=menuOptions[r];r===menuSelection&&bC.drawRect(50,e-4,50+bC.stringWidth(o)+8,20+e),bC.drawString(o,54,e)}bC.flip()}inMenu=!0,e(),Pip.removeAllListeners(),Pip.on("knob1",r=>{0===r?(inMenu=!1,vsCPU=1===menuSelection,resetGame()):0<r?(menuSelection=(menuSelection+1)%menuOptions.length,e()):r<0&&(menuSelection=(menuSelection+menuOptions.length-1)%menuOptions.length,e())}),Pip.on("torch",()=>{bC.clear(),E.reboot()})}setTimeout(showMainMenu,100);